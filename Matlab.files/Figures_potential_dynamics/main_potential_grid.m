clear all
set(groot,'defaultAxesTickLabelInterpreter','latex','defaulttextinterpreter','latex','defaultLegendInterpreter','latex');

% Generate a random potential;
n = 10;
I = eye(n);
rng(1,'twister');
P = randi(9,n);
P(n,n) = 10;
P = diag(1:n);
A = P;
B = A';

%Avoid numerical instabilities at 0 and 1.
epsilon = 1e-200;
L = epsilon;
U = 1-epsilon;

% Global parameters: number of rounds (updates of betas/distibutions) and number of Q-value updates (inner) in each round
iter   = 1e+03;
inner  = 1e+20;
tplot  = 1:iter;

%create almost pure starting points, one for each action
prob = 0.999;
for i = 1:n
    x0(:,i) = ones(n,1)*(1-prob)/(n-1);
    x0(i,i) = prob;
end
y0 = x0;

%choose a nxn grid of starting points (n^2 experiments)
x = zeros(n,n^2,iter);
y = x;
x(:,:,1) = repmat(x0,1,n);
y(:,:,1) = repelem(y0,1,n*ones(1,n));
exper = size(x,2);
Qx = zeros(n,exper,iter);
Qy = y;

% X-player parameters;
min_x = 0.0001;
max_x = 4;
low_x = 0.000001;
end_x = 0.1*iter;
top_x = 0.5;

% X-Policies: ETE, CLR-1
rates_ete_x = [linspace(max_x,min_x,iter-end_x) linspace(min_x, low_x, end_x)];
rates_clr_x = [linspace(min_x,max_x,(iter-end_x)*top_x) linspace(max_x,min_x,(iter-end_x)*(1-top_x)) linspace(min_x, low_x, end_x)];
%rates_clr_x = rates_clr_x.^2;

% Y-player parameters;
min_y = 0.0001;
max_y = 2;
low_y = 0.00001;
end_y = 0.1*iter;
top_y = 0.6;

% Y-Policies: ETE, CLR-1
rates_ete_y = [linspace(max_y,min_y,iter-end_y) linspace(min_y, low_y, end_y)];
rates_clr_y = [linspace(min_y,max_y,(iter-end_y)*top_y) linspace(max_y,min_y,(iter-end_y)*(1-top_y)) linspace(min_y, low_y, end_y)];
%rates_clr_y = rates_clr_y.^2;

% Exploration-exploitation policy of agent x.
rates_x = rates_clr_x;
xbar    = max(rates_x);
rates_x = xbar-rates_x;
a_x     = 0.01*ones(1,iter);
b_x     = rates_x.*a_x;

% Exploration-exploitation policy of agent y.
rates_y = rates_clr_y;
ybar    = max(rates_y);
rates_y = ybar-rates_y;
a_y     = 0.01*ones(1,iter);
b_y     = rates_y.*a_y;

%Potential function
potential = zeros(exper,iter);

for j=1:exper
    potential(j,1)=dot(x(:,j,1),A*y(:,j,1));
end

% Dynamics: Q-values and strategy updates for each experiment

for t=1:iter-1
    for j=1:exper
        nx = x(:,j,t)*inner;
        ny = y(:,j,t)*inner;     
        for i=1:n
            Qx(i,j,t+1) = dot(I(:,i),A*y(:,j,t))*(1-(1-a_x(t))^(nx(i)+1))/a_x(t)+(1-a_x(t))^nx(i)*Qx(i,j,t);
            Qy(i,j,t+1) = dot(I(:,i),B*x(:,j,t))*(1-(1-a_y(t))^(ny(i)+1))/a_y(t)+(1-a_y(t))^ny(i)*Qy(i,j,t);
        end
        x(:,j,t+1) = b_x(t)*Qx(:,j,t+1)-log(norm(exp(b_x(t)*Qx(:,j,t+1)),1));
        y(:,j,t+1) = b_y(t)*Qy(:,j,t+1)-log(norm(exp(b_y(t)*Qy(:,j,t+1)),1));
%        x(:,j,t+1) = x(:,j,t+1)/norm(x(:,j,t+1),1);
%        y(:,j,t+1) = y(:,j,t+1)/norm(y(:,j,t+1),1);
        x(:,j,t+1) = min(exp(x(:,j,t+1)),U);
        y(:,j,t+1) = min(exp(y(:,j,t+1)),U);
        x(:,j,t+1) = exp(log(x(:,j,t+1))-log(norm(x(:,j,t+1),1)));
        y(:,j,t+1) = exp(log(y(:,j,t+1))-log(norm(y(:,j,t+1),1)));
        potential(j,t+1) = dot(x(:,j,t+1),A*y(:,j,t+1));
    end
end

fig1 = figure(1);
subplot(2,2,1)
box on
hold all
for i=1:n-1
    plot(tplot,squeeze(mean(log(x(i,:,:)))),'Linestyle','none','Marker','.','MarkerSize',3,'color','#4DBEEE');
end
hold on
plot(tplot,squeeze(mean(log(x(n,:,:)))),'Linestyle','none','Marker','.','MarkerSize',3,'color','#A2142F');
hold on
pnx = plot(nan,nan,'color','#A2142F');
title({'$\log{(x_i)}$'}, 'Interpreter', 'latex')
xlim([0 iter+2])
%ylim([-52 2]);
legend(pnx, 'optimal action','Location','southwest')

subplot(2,2,2)
box on
hold all
for i=1:n-1
    plot(tplot,squeeze(mean(log(y(i,:,:)))),'Linestyle','none','Marker','.','color','#4DBEEE','MarkerSize',3);
end
hold on
plot(tplot,squeeze(mean(log(y(n,:,:)))),'Linestyle','none','Marker','.','MarkerSize',3,'color','#A2142F');
hold on
pny = plot(nan,nan,'color','#A2142F');
title('$\log{(y_i)}$');
xlim([0 iter+2]);
%ylim([-52 2]);
legend(pny, 'optimal action','Location','southwest')
%exportgraphics(fig1,['figure_appendix_potential_prob_' num2str(P(1,1)) '.png'],'BackgroundColor','white','Resolution','500')
%% Figure 2

fig2 = figure(2);
subplot(2,2,1)
box on
plot_distribution(tplot,potential)
%plot_distribution_prctile(1:iter+1,potential,'Prctile',[25 50 75 90])
%plot(1:iter+1,mean(potential),'Linestyle','none','Marker','.','MarkerSize',3);
xlim([0 iter+2]);
ylim([0 P(n,n)+2]);
title('Average potential $\Phi$')

subplot(2,2,2)
p2 = plot(tplot,ybar-rates_y);
hold on
p1 = plot(tplot,xbar-rates_x);
xlim([0 iter+1]);
ylim([0 4]);
yticks([0 2 4]);
title('Exploration rates: $\delta_x,\delta_y$')
legend([p1 p2], {'agent 1', 'agent 2'},'Location','northoutside')

exportgraphics(fig2,['figure_appendix_potential_' num2str(P(1,1)) '.png'],'BackgroundColor','white','Resolution','500')